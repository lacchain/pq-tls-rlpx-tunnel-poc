version: "3.3"

services:
  relay-signer:
    image: ghcr.io/lacchain/pq-relay-signer
    environment:
      - PQ_RELAY_SIGNER_REMOTE_HOST=33c8fea
      - PQ_RELAY_SIGNER_ETHEREUM_SK=0x8f2a55949038a9610f50fb23b5883af3b4ecb3c3bb792cbcefbd1542c692be63
      - PQ_RELAY_SIGNER_FALCON_SK=0x59ffcdc5073fc203df810c1f3f0fe04403e1c31fa0bafb8102f79003fc2f0203f03effb046f00105ec2ec7085fc1f49ffd03ffc0003f7dfc5f07fc3f3d0c3fc10c10bffbef3e07df43e89fb8e8114000003eefdfc317bffc1bf03b03df43f3fffef052ff1090ff18010803c03c109f45fc00cef01fbf17b03dfc010223efc2fbc17f1fbf82fc3ebf0bd10117ff8523d303f7be81e800852c2ebd1030fffbdf82080e80f400c0fc20c1dc4fbee7e044e40104fcaf7c1c00430c6f3a04113df8004a081fbd001f80279f000bf043f3e0b8082fbf17d042ffbf44fb7f0307bfbdf43100046ec0fc4080fbef49dffe40ec01380c1183e3800203f0befc00bb13afc0dfe14014410207e0870420090bf084f4323ee83f420fdfbdfbf042fbafc718a03e1c4fc0e82081eb7000efbfbaf44f41f3efbf080e8317df45101fcafbf07ff3ffc30440beffbf05fbff82e42f05fbbf7feff081fc3083f43f7e1bd0f9f7f0c1f49f3c07b07dfc0f8217cdb8fc2f82f7c204fc8dfef7a100000fc200003cec0001244f42fc21420860c507a03d1c21000400fb1c5f4207c0bb23ff7d03f0c0fc4f42e4403be48f7d07827e13d1c0ffaf020ff337f04081044ebe0b8f3cf39086f4207d085f3e079004040d3be7ef030000861be04407d084f7ff06200e8213d0fdec0102043086f04d81f8cfbe08100508807ef4403b0fcef917d045f81ff927afc617bf06e7bf81048ec4f450ba083e3debcfbe13bfc107f04403ef82fbd0c1f800010bff7d0c2fc21060ff085f850be0021bdf03040ffff06083ec4085fc00790be03e086fbd0030fef80f42f0113c0c214314203cf79ec30c2efefbd0b9ec4139f821ff079040f7b07e079079045fc0ffcfc3140f81ffef47133040efa078f39e83f7ef7d0041fb07f14314617ff00ff9201ec40812bc1f9fbf0c7fc1085e41003102ffdff90800c0040040fc3f7cf79d7ef440fdf06fc4fbd1450c90c10c2fbce82f00004f81f42182f07f3df3d101f8104010807c004003f7ce84f46dc1d8410003effce83180f470fff030c0f3ef3fffe17edfaf020be103dc11fee820bc0313d8eff4f001ed030200fd09e21af8def31a141f23e405081d24cbf60bcd2204f3e503f8d9fc27f317102506fc19201526d0e9210d1ce504c6f809f5e10ff1e013f0f9ff20e310220d29fbf3e403f1eafcdd0907d9d3eee622edf5f808e9f90204123ff2cc34fd171817c4f0370a0d1cd1ec0e09effc1108eeeb0a1afe0d0d3e1e142e251e13f5ed01e82011f10f15fd4005f2faf011f10a2515101e1f07fcf902311b0b07fdfee6f4dcbae8ecf0e71d3c2e0beb210ce9200eebfaca111e11fbe4f8f3c601beefded91ff4f2db071d1b032252da33f60a281d14dcef04e421e107dde90f1cf4edf7ee00f607e3e704f40a0c272a04c22b00f30c00d9eaeee809ebd1d9ea16e8281c0fe1fc250beee7d511eb0ef3db2cf8dc40e5d11bdbf0fc29f5f7ff493017ebec110d39180704cdfcf904e21204d4eb130cf50ae2ee2ff8f3f6de2b18fe0edd2636100500fae800e7eddcda01ec0b0209f82ff01424ffea0ded0cfef3ef3407dfe4c8efeddd360e050324fb082df8111c44f5080c251135ed0109c6060db52724020909faf810e90bf9fe4610dce0341cf90a15f1f1d5dd21d8010aeb0102f1060d03e1dc15fe46f2f115fbccfefc22e9dcebecf0091006eadefef3b7f9e20dff0f11fbfb271a0132ed0210190dc50fc4e40d13bfd904edd72ff90c02f302290724fe1a2115e6131123e61debfb1ff7f435bfe600f6cb13
      - PQ_RELAY_SIGNER_FALCON_PK=0x095c244d1699408a9d213a045cc37f61de0e45e4252b34f8cf06ed000f9f89af86bae6149075d4f757afcc9e55c31a6cc31b48c515248e800d0a25c2ebc14af7086d27c21c136615f2457b4b0a478a524f2501244ca3496dd927e62485e22ab0ce28b373058e5bb002d6549049096057649a9092c2a76b37265a494331acfb41a4f3e66601f3ab0277851ba97a7c11ea03758c2bb0761bf64d8ad39f5c0b01eac6a509b5648266e1e998fecc875c565a33e04c68c910267b0566d7d39fdc002d0468a88edb5bda127bc645265a6c14599b6f9d4faa10b3bd5535b449bc033388b2a9193ae0878e5137d55949d569a35656f5887f0913a11ca6f70c4f184721cd783f5236b275d2c253e078313093c05ed6392d58c28b0f50544f20b002535695379e516097078aadb113369a43f7892452654ce3f791088bd044094586dd7e337c48202fbd5651aed0e1319001331fa960af590e128106ff430a80054b23c8384d1a66745d092b61a333344f414440b5a919a531118412925564c7b284e456fa2a5e505d210179c973bd110b335946df51d298522b13b15a313068d58688ad6a399010242d333451674312f81b0844576c6ab28a49f5f31bd2df9f04d8d5289d0d0689202379d1e88905437002cdca250669f275af114c683b244a2e8641240571fd2bf6159def8187a597a165af43e56c7ab21c2bb13b8ec0697d4b1146aa22a366d52a7da83178d1e1b7ffe2ac14b5b8f9b455544b2e38cb800c1706b679a3bdc7ff8b897ba1a7d140ae62dc546597c90c822a80ab4ef9599285955f5fe24b768d5aca6b6b6446f669390fe34a9a5f09902c0090058200e7adaf46ce1fda94d974ac4a291bc30d34093c32709e6144608c8271a38ad2243616d06b0dd38e9656910de10e9f5af3501f0d227e5904e322d483646aefca9ad4875909bb44aec5abb00836f5f1d0b97f7acd7059452b4f56dfb2e946bc6cad13566285249f41ef7408c294a6c993413b2f3121c2d6714c6b7f9830fa91a21c2d237d6429f642e43776abd487e6ec8459d94b3d17632a64e341592e8520102227950210503427a12b9058802041c7cfab0c10c4d9c9396356abecd01158ec5eb8ac9c8724c0b8a991a40900c1b0a6b271a1216ee817d60d81f3653919b2634830cd03a65ab0f3d05c7990d1afc7f7a6ef2f4428595aecd29a715911fe48559bd64135f0261a8b097e8792123b77164819ab8cbcb3348f62b746dd559ac5f900c19771c115121f9e5e
      - PQ_RELAY_SIGNER_RELAY_HUB_ADDRESS=0x42699a7612a82f1d9c36148af9c77354759b210b
    ports:
      - 5050:5050

  setup:
    build:
      context: ./setup/
    environment:
      - NODE_REMOTE_HOST=33c8fea
      - NODE_REMOTE_PORT=8545
      - ETHEREUM_SK=0x8f2a55949038a9610f50fb23b5883af3b4ecb3c3bb792cbcefbd1542c692be63
    command: ["wait-for-it", "33c8fea:8545", "--", "/run.sh"]

  33c8fea:
    build:
      context: ./besu/
    image: besu
    volumes:
      - ./besu/genesis.json:/genesis.json
      - ./besu/33c8fea/key:/key
      - ./besu/33c8fea/static-nodes.m4:/static-nodes.m4
      - ./besu/33c8fea/iptables.rules.sh:/iptables.rules.sh
    environment:
      - BESU_NODE_PRIVATE_KEY_FILE=/key
      - BESU_GENESIS_FILE=/genesis.json
      - BESU_PERMISSIONS_ACCOUNTS_CONTRACT_ENABLED=true
      - BESU_PERMISSIONS_ACCOUNTS_CONTRACT_ADDRESS=0x0000000000000000000000000000000000008888
      - BESU_RPC_WS_ENABLED=true
      - BESU_RPC_WS_HOST=0.0.0.0
      - BESU_RPC_HTTP_ENABLED=true
      - BESU_RPC_HTTP_HOST=0.0.0.0
      - BESU_HOST_ALLOWLIST=*
      - BESU_RPC_HTTP_CORS_ORIGINS=*
      - BESU_DISCOVERY_ENABLED=false
      - BESU_MIN_GAS_PRICE=0
      - BESU_LOGGING=OFF
    expose:
      - 8545
    ports:
      - 8545:8545
      - 8546:8546
    cap_add:
      - NET_ADMIN

  client:
    build: 
      context: ./stunnel/
    image: stunnel
    environment:
      - CLIENT=yes
      - SERVICE=client
      - ACCEPT=0.0.0.0:4911
      - CONNECT=server:4912
    volumes:
      - ./stunnel/client.crt:/etc/stunnel/service.crt
      - ./stunnel/client.key:/etc/stunnel/service.key
    expose:
      - "4911"

  server:
    image: stunnel
    environment:
      - CLIENT=no
      - SERVICE=server
      - ACCEPT=0.0.0.0:4912
      - CONNECT=9ab5623:30303
    volumes:
      - ./stunnel/server.crt:/etc/stunnel/service.crt
      - ./stunnel/server.key:/etc/stunnel/service.key
    expose:
      - "4912"

  9ab5623:
    image: besu
    volumes:
      - ./besu/genesis.json:/genesis.json
      - ./besu/9ab5623/key:/key
      - ./besu/9ab5623/iptables.rules.sh:/iptables.rules.sh
    environment:
      - BESU_NODE_PRIVATE_KEY_FILE=/key
      - BESU_GENESIS_FILE=/genesis.json
      - BESU_PERMISSIONS_ACCOUNTS_CONTRACT_ENABLED=true
      - BESU_PERMISSIONS_ACCOUNTS_CONTRACT_ADDRESS=0x0000000000000000000000000000000000008888
      - BESU_DISCOVERY_ENABLED=false
      - BESU_MIN_GAS_PRICE=0
      - BESU_LOGGING=DEBUG
      - BESU_MINER_ENABLED=true
      - BESU_MINER_COINBASE=0000000000000000000000000000000000000000
    expose:
      - "30303"
    cap_add:
      - NET_ADMIN
